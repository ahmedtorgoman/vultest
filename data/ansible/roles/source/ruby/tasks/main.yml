---
- name: Install ruby in root
  bock:
    - name: git clone --depth 1 https://github.com/sstephenson/rbenv.git
      git:
        repo: "https://github.com/sstephenson/rbenv.git"
        dest: /root/.rbenv
        depth: "1"

    - name: git clone --depth 1 https://github.com/sstephenson/ruby-build.git
      git:
        repo: "https://github.com/sstephenson/ruby-build.git"
        dest: /root/.rbenv/plugins/ruby-build
        depth: "1"

    - name: Set the environment of ruby in .bashrc
      lineinfile:
        dest: /root/.bashrc
        line: "{{ item }}"
      with_items:
        - 'export PATH="/root/.rbenv/bin:$PATH"'
        - 'eval "$(rbenv init -)"'

    - name: source .bashrc
      shell: /bin/bash -lc "source /root/.bashrc"

    - name: rbenv install "{{ version }}"
      shell: bash -lc "rbenv install {{ version }}"
      ignore_errors: True

    - name: rbenv global "{{ version }}"
      shell: bash -lc "rbenv global {{ version }}"

- name: Install ruby in user
  bock:
    - name: git clone --depth 1 https://github.com/sstephenson/rbenv.git
      git:
        repo: "https://github.com/sstephenson/rbenv.git"
        dest: "{{ user_dir }}/.rbenv"
        depth: "1"
      become_user: "{{ user }}"

    - name: git clone --depth 1 https://github.com/sstephenson/ruby-build.git
      git:
        repo: "https://github.com/sstephenson/ruby-build.git"
        dest: "{{ user_dir }}/.rbenv/plugins/ruby-build"
        depth: "1"
      become_user: "{{ user }}"

    - name: Set the environment of ruby in .bashrc
      lineinfile:
        dest: "{{ user_dir }}/.bashrc"
        line: "{{ item }}"
      with_items:
        - 'export PATH="~/.rbenv/bin:$PATH"'
        - 'eval "$(rbenv init -)"'
      become_user: "{{ user }}"

    - name: source .bashrc
      shell: /bin/bash -lc "source {{ user_dir }}/.bashrc"
      become_user: "{{ user }}"

    - name: rbenv install "{{ version }}"
      shell: bash -lc "rbenv install {{ version }}"
      ignore_errors: True
      become_user: "{{ user }}"

    - name: rbenv global "{{ version }}"
      shell: bash -lc "rbenv global {{ version }}"
      become_user: "{{ user }}"
  when: (user is defined) and (user_dir is defined)
