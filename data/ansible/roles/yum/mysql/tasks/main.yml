---
- name: Remove MongDB
  yum:
    name: mariadb-libs
    state: absent
- name: rm -rf /var/lib/mysql
  file:
    path: /var/lib/mysql
    state: absent

- name: Add RPM of mysql-*
  yum:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - "https://downloads.mysql.com/archives/get/p/23/file/mysql-community-common-{{ version }}-1.el{{ os_core_version }}.x86_64.rpm"
      - "https://downloads.mysql.com/archives/get/p/23/file/mysql-community-libs-{{ version }}-1.el{{ os_core_version }}.x86_64.rpm"
      - "https://downloads.mysql.com/archives/get/p/23/file/mysql-community-devel-{{ version }}-1.el{{ os_core_version }}.x86_64.rpm"
      - "https://downloads.mysql.com/archives/get/p/23/file/mysql-community-client-{{ version }}-1.el{{ os_core_version }}.x86_64.rpm"
      - "https://downloads.mysql.com/archives/get/p/23/file/mysql-community-server-{{ version }}-1.el{{ os_core_version }}.x86_64.rpm"

- name: yum install mysql-*
  yum:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - mysql-community-common
      - mysql-community-libs
      - mysql-community-devel
      - mysql-community-client
      - mysql-community-server

- name: yum install python-pip
  yum:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - python-devel
      - python-pip

- name: pip install MySQL-python
  pip:
    name: MySQL-python

- name: Check to see if it needs to be initialized.
  shell: cat /etc/my.cnf | grep "validate-password=OFF"
  register: init_flag
  failed_when: no

- name: Initialization of MySQL
  block:
    - name: "mkdir {{ data_dir }}"
      file:
        path: "{{ data_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Database Initialization
      shell: "/usr/bin/mysql_install_db --user={{ user }} --basedir={{ base_dir }} --datadir={{ data_dir }}"

    - name: service mysqld start
      service:
        name: mysqld
        state: started

    - name: Add "validate-password=OFF" in /etc/my.cnf
      lineinfile:
        dest: /etc/my.cnf
        line: "validate-password=OFF"

    - name: Get the password of root(mysql)
      shell: 'cat /var/log/mysqld.log | grep  "root@localhost:" | sed -e "s/\(.*\): \(.*\)/\2/g"'
      register: initial_password

    - name: service mysqld restart
      service:
        name: mysqld
        state: restarted

    - name: Change password of root in mysql
      shell: mysql -u root -p"{{ initial_password.stdout }}" --connect-expired-password -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ root_password }}';"
  when: init_flag.rc  == 1

- name: service mysqld start
  service:
    name: mysqld
    state: started
