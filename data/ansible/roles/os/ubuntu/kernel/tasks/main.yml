---
- name: apt install "{{ name_and_version }}"
  apt:
    name: "{{ name_and_version }}"
    state: present
    update_cache: no

- name: uname -r
  shell: bash -lc "uname -r"
  register: def_kernel_version
- name: apt purge "linux-image-{{ def_kernel_version.stdout }}"
  apt:
    name: "linux-image-{{ def_kernel_version.stdout }}"
    purge: yes
    state: absent
    update_cache: no
    install_recommends: no
  when: '"{{ name_and_version }}" != "linux-image-{{ def_kernel_version.stdout }}"'
  ignore_errors: True

- name: "dpkg --list | grep linux-image | awk '{print $2}' | sed -n -e 1p"
  shell: dpkg --list | grep linux-image | awk '{print $2}' | sed -n -e 1p
  register: kernel_version
- name: dpkg --configure -a
  shell: bash -lc "dpkg --configure -a"
  ignore_errors: True
- name: apt-get -f install
  shell: bash -lc "apt-get -f install"
  register: install_result
  ignore_errors: True
- name: "rm -rf /var/lib/dpkg/info/{{ kernel_version.stdout }}.*"
  shell: bash -lc "rm -rf /var/lib/dpkg/info/{{ kernel_version.stdout }}.*"
  when: install_result is failed

- name: apt purge "{{ kernel_version.stdout }}"
  apt:
    name: "{{ kernel_version.stdout }}"
    purge: yes
    state: absent
    update_cache: no
    install_recommends: no
  when: '"{{ name_and_version }}" != "{{ kernel_version.stdout }}"'
  ignore_errors: True

- name: "dpkg --list | grep linux-image | awk '{print $2}' | sed -n -e 2p"
  shell: dpkg --list | grep linux-image | awk '{print $2}' | sed -n -e 2p
  register: kernel_version
  when: install_result is success
- name: apt purge "{{ kernel_version.stdout }}"
  apt:
    name: "{{kernel_version.stdout}}"
    purge: yes
    state: absent
    update_cache: no
    install_recommends: no
  when:
    - install_result is success
    - '"{{ name_and_version }}" != "{{ kernel_version.stdout }}"'

- name: update-grub
  shell: bash -lc "update-grub"
