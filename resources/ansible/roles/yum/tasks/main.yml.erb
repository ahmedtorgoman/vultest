---
<% if name == 'mysql' %>
- name: Remove Mongodb software and settings
  block:
    - name: Remove MongDB
      yum:
        name: mariadb-libs
        state: absent

    - name: rm -rf /var/lib/mysql
      file:
        path: /var/lib/mysql
        state: absent

- name: Install MySQL
  block:
    - name: Download MySQL
      get_url:
        url: "https://downloads.mysql.com/archives/get/p/23/file/mysql-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm-bundle.tar"
        dest: /usr/local/src
        validate_certs: no

    - name: Unarchive mysql
      unarchive:
        src: "/usr/local/src/mysql-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm-bundle.tar"
        dest: /usr/local/src
        copy: no

    - name: "yum localinstall mysql-community-common-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
      yum:
        name: "/usr/local/src/mysql-community-common-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
        state: present

    - name: "yum localinstall mysql-community-libs-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
      yum:
        name: "/usr/local/src/mysql-community-libs-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
        state: present

    - name: "yum localinstall mysql-community-libs-compat-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
      yum:
        name: "/usr/local/src/mysql-community-libs-compat-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
        state: present

    - name: "yum localinstall mysql-community-devel-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
      yum:
        name: "/usr/local/src/mysql-community-devel-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
        state: present

    - name: "yum localinstall mysql-community-client-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
      yum:
        name: "/usr/local/src/mysql-community-client-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
        state: present

    - name: "yum localinstall mysql-community-server-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
      yum:
        name: "/usr/local/src/mysql-community-server-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
        state: present

- name: Install a MySQL extension
  block:
    - name: yum install python-pip
      yum:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
          - python-devel
          - python-pip

    - name: pip install MySQL-python
      pip:
        name: MySQL-python

- name: Check to see if it needs to be initialized.
  stat:
    path: "{{ data_dir }}"
  register: mysql_dir
  failed_when: no

- name: Initialize MySQL
  block:
    - name: "mkdir {{ data_dir }}"
      file:
        path: "{{ data_dir }}"
        state: directory
        owner: mysql
        group: mysql
        mode: "0755"

    - name: Database Initialization
      shell: "mysql_install_db --user={{ user }} --basedir={{ base_dir }} --datadir={{ data_dir }}"

    - name: "touch  {{ data_dir }}/mysql.sock"
      file:
        path: "{{ base_dir }}/mysql.sock"
        state: touch
        owner: mysql
        group: mysql
        mode: "0755"

    - name: service mysqld start
      service:
        name: mysqld
        state: started
        enabled: yes

    - name: Get the password of root(mysql)
      shell: 'cat /var/log/mysqld.log | grep  "root@localhost:" | sed -e "s/\(.*\): \(.*\)/\2/g"'
      register: root_default_password

    - name: Modify root
      block:
        - name: Change password of root in mysql
          shell: mysql -u root -p"{{ root_default_password.stdout }}" --connect-expired-password -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ root_password }}';"

        - name: Change root privileges
          mysql_user:
            name: root
            password: "{{ root_password }}"
            host: "localhost"
            priv: "*.*:ALL,GRANT"
            state: present
            host_all: yes
            login_user: root
            login_password: "{{ root_password }}"
            config_file: /etc/my.cnf

  when: mysql_dir.stat.exists == false
<% else %>
<% if version.nil?%>
- name: "yum install {{ name }}"
  yum:
    name: "{{ name }}"
    state: present
    update_cache: no
<% else %>
- name: "yum install {{ name }}-{{ version }}"
  yum:
    name: "{{ name }}-{{ version }}"
    state: present
    update_cache: no
<% end %>
<% end %>