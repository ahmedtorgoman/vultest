---
<% if name == 'mysql' %>
- name: Remove MongDB
  yum:
    name: mariadb-libs
    state: absent
- name: rm -rf /var/lib/mysql
  file:
    path: /var/lib/mysql
    state: absent

- name: Download MySQL
  get_url:
    url: "https://downloads.mysql.com/archives/get/p/23/file/mysql-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm-bundle.tar"
    dest: /usr/local/src
    validate_certs: no
- name: Unarchive mysql
  unarchive:
    src: "/usr/local/src/mysql-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm-bundle.tar"
    dest: /usr/local/src
    copy: no

- name: "yum localinstall mysql-community-common"
  yum:
    name: "/usr/local/src/mysql-community-common-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
    state: present
- name: "yum localinstall mysql-community-libs"
  yum:
    name: "/usr/local/src/mysql-community-libs-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
    state: present
- name: "yum localinstall mysql-community-libs-compat"
  yum:
    name: "/usr/local/src/mysql-community-libs-compat-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
    state: present
- name: "yum localinstall mysql-community-devel"
  yum:
    name: "/usr/local/src/mysql-community-devel-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
    state: present
- name: "yum localinstall mysql-community-client"
  yum:
    name: "/usr/local/src/mysql-community-client-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
    state: present
- name: "yum localinstall mysql-community-server"
  yum:
    name: "/usr/local/src/mysql-community-server-{{ version }}-1.el{{ ansible_distribution_major_version }}.x86_64.rpm"
    state: present

- name: yum install python-pip
  yum:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - python-devel
      - python-pip
- name: pip install MySQL-python
  pip:
    name: MySQL-python

- name: rm -rf /var/lib/mysql
  file:
    path: /var/lib/mysql
    state: absent

- name: service mysqld restart
  service:
    name: mysqld
    state: restarted

- name: touch /var/lib/mysql/mysql.sock
  file:
    path: /var/lib/mysql/mysql.sock
    state: touch
    mode: 0755

- name: Get the password of root(mysql)
  shell: >-
    cat /var/log/mysqld.log |
    grep  "root@localhost:" |
    tail -n 1 |
    sed -e "s/\(.*\): \(.*\)/\2/g"
  register: default_password

- name: Change password of root in mysql
  shell: mysql -u root -p"{{ default_password.stdout }}" --connect-expired-password -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ password }}';"

- name: Change root privileges
  mysql_user:
    name: root
    password: "{{ password }}"
    host: "localhost"
    priv: "*.*:ALL,GRANT"
    state: present
    host_all: yes
    login_user: root
    login_password: "{{ password }}"
    config_file: /etc/my.cnf

<% else %>
<% if version.nil?%>
- name: "yum install {{ name }}"
  yum:
    name: "{{ name }}"
    state: present
    update_cache: no
<% else %>
- name: "yum install {{ name }}-{{ version }}"
  yum:
    name: "{{ name }}-{{ version }}"
    state: present
    update_cache: no
<% end %>
<% end %>