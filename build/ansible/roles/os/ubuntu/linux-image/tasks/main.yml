---
- name: apt-get install "linux-image-{{version}}"
  apt:
    name: "{{item}}"
    state: present
    update_cache: no
  with_items:
    - "linux-image-{{version}}"

- name: uname -r
  shell: bash -lc "uname -r"
  register: def_kernel_version

- name: apt-get purge "linux-image-{{def_kernel_version.stdout}}"
  apt:
    name: "linux-image-{{def_kernel_version.stdout}}"
    purge: yes
    state: absent
    update_cache: no
    install_recommends: no
  when: '"{{version}}" != "{{def_kernel_version.stdout}}"'

- name: "dpkg --list | grep linux-image | awk '{print $2}' | sed -n -e 1p"
  shell: dpkg --list | grep linux-image | awk '{print $2}' | sed -n -e 1p
  register: latest_kernel_version

- name: apt-get purge "{{latest_kernel_version.stdout}}"
  apt:
    name: "{{latest_kernel_version.stdout}}"
    purge: yes
    state: absent
    update_cache: no
    install_recommends: no
  when: '"linux-image-{{version}}" != "{{latest_kernel_version.stdout}}"'

- name: update-grub
  shell: bash -lc "update-grub"
