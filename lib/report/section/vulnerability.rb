# Copyright [2020] [University of Aizu]
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License

require 'lib/report/section/base'

module Report
  module Section
    class Vulnerability < Base
      attr_reader :cve

      def initialize(args)
        @cve = args[:cve]
      end

      def create
        section = "## Vulnerability\n\n"
        section << cve_section
        section << cpe_section
      end

      private

      def cve_section
        output = ''
        cve_info = DB.get_cve_info(cve)
        unless cve_info['description'].nil?
          sentence = ''
          cve_info['description'].split(' ') do |str|
            sentence += sentence.empty? ? str : " #{str}"

            next if sentence.size < 100

            output += "> #{sentence}\n"
            sentence = ''
          end
          output += "> #{sentence}\n" unless sentence.empty?
        end

        section = "### CVE Description\n"
        section << "#{output}\n"
      end

      def cpe_section
        section = "### Affect Software Version (CPE)\n"
        cpe = DB.get_cpe(cve)
        cpe.each do |cpe_info|
          output_cpe_info = ''
          cpe_info.each_char { |c| output_cpe_info += c == '*' ? '\\' + c : c }
          section << "- #{output_cpe_info}\n"
        end
        section << "\n"
      end
    end
  end
end
